<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        var chunkedUrl = 'http://localhost:3000/api/p?lon=4675900&lat=3968675&res=36&oh=2';
        fetch(chunkedUrl)
            .then(processChunkedResponse)
            .then(onChunkedResponseComplete)
            .catch(onChunkedResponseError)
            ;

        function onChunkedResponseComplete(result) {
            console.log('all done!', result)
        }

        function onChunkedResponseError(err) {
            console.error(err)
        }

        function processChunkedResponse(response) {
            var text = '';
            var reader = response.body.getReader()
            var decoder = new TextDecoder();

            return readChunk();

            function readChunk() {
                return reader.read().then(appendChunks);
            }

            function appendChunks(result) {
                var chunk = decoder.decode(result.value || new Uint8Array, { stream: !result.done });
                console.log('got chunk of', chunk.length, 'bytes:');
                console.log(chunk);
                text += chunk;
                console.log('text so far is', text.length, 'bytes\n');
                if (result.done) {
                    console.log('returning')
                    return text;
                } else {
                    console.log('recursing')
                    return readChunk();
                }
            }
        }
    </script>
</body >
</html >